name: Build and Deploy to Replicate

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    # Use Blacksmith GPU runner with CUDA support
    # Available labels: blacksmith-4vcpu-ubuntu-2204-cuda-12-1, blacksmith-8vcpu-ubuntu-2204-cuda-12-1, etc.
    runs-on: blacksmith-4vcpu-ubuntu-2204-cuda-12-1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify CUDA availability
        run: |
          nvidia-smi
          nvcc --version || echo "nvcc not found, but nvidia-smi should be sufficient"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Cog
        run: |
          sudo curl -o /usr/local/bin/cog -L https://github.com/replicate/cog/releases/download/v0.8.6/cog_$(uname -s)_$(uname -m)
          sudo chmod +x /usr/local/bin/cog
          cog --version

      - name: Log in to Replicate
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          echo "$REPLICATE_API_TOKEN" | sudo cog login --token-stdin

      - name: Download models to container
        run: |
          sudo cog run python script/download_models.py

      - name: Build and push to Replicate
        run: |
          sudo cog push r8.im/wordscenes/whisper-stable-ts

      - name: Get deployed version
        run: |
          echo "Deployment complete! Check the latest version at:"
          echo "https://replicate.com/wordscenes/whisper-stable-ts/versions"
